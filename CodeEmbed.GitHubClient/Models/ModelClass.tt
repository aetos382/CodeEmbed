<#@ template debug="false" hostspecific="false" language="C#" #>

<#@ assembly name="System.Core" #>
<#@ assembly name="System.Xml" #>
<#@ assembly name="System.Xml.Linq" #>

<#@ import namespace="System" #>
<#@ import namespace="System.Linq" #>
<#@ import namespace="System.Xml.Linq" #>

<#@ parameter name="CodeNamespace" type="System.String" #>
<#@ parameter name="ModelDefinition" type="System.String" #>

<#@ include file="ModelDefinitionParser.ttinclude" #>

<#
    var model = Model.Parse(ModelDefinition);

    string modelName = model.Name.LocalName;

    bool hasRequiredMember = model.Members.Any(x => x.Required);

    var namespaces = new List<string> {
            "System",
            "System.CodeDom.Compiler",
            "System.Diagnostics.Contracts",
			CodeNamespace
        };

    if (hasRequiredMember)
    {
        namespaces.Add(CodeNamespace + ".Models.Contracts");
    }
	
	var additionalNamespaces = model.Members
		.Select(x => x.Type.NamespaceName)
		.Distinct()
		.Where(x => x.StartsWith(ClrNamespace.NamespaceName))
		.Select(x => x.Substring(ClrNamespace.NamespaceName.Length));

	namespaces.AddRange(additionalNamespaces);

    var orderedNamespaces = OrderNamespace(namespaces);

    string camelCasedModelName = ToCamelCase(modelName);

    var members = MemberDefinition.ParseModel(modelDefinition);

    bool ancestorsHasClient = ParentModelDefinitionXmls.Select(x => (bool?)XElement.Parse(x).Attribute("hasClient") ?? false).Any(x => x);
    bool hasClient = !ancestorsHasClient && ((bool?)modelDefinition.Attribute("hasClient") ?? false);
#>

namespace <#= CodeNamespace #>.Models
{
	using System;
	using System.CodeDom.Compiler;
	using System.Collections.Generic;
	using System.ComponentModel;
	using System.Diagnostics;
	using System.Diagnostics.Contracts;
<#
    if (hasClient || ancestorsHasClient)
    {
#>

	using <#= CodeNamespace #>;
<#    
    }
#>

	[GeneratedCode("ModelClass.tt", "1.0")]
	[DebuggerStepThrough]
	public partial class <#= modelName #><#= GeneratedModelPostfix #> :
<#
    if (inherits != null)
    {
#>
		<#= inherits #><#= GeneratedModelPostfix #>,
<#
    }
#>
		I<#= modelName #><#= GeneratedModelPostfix #>
	{
		private readonly I<#= modelName #><#= GeneratedModelPostfix #> _<#= camelCasedModelName #>;

<#
    if (hasClient)
    {
#>
		[ContractPublicPropertyName("Client")]
		private readonly IGitHubClient _client;

<#
    }
#>
		/// <summary>Create new instance of <#= modelName #><#= GeneratedModelPostfix #>.</summary>
		public <#= modelName #><#= GeneratedModelPostfix #>(
			I<#= modelName #><#= GeneratedModelPostfix #> <#= camelCasedModelName #><#= (hasClient || ancestorsHasClient ? "," : ")") #>
<#
    if (hasClient || ancestorsHasClient)
    {
#>
			IGitHubClient client)
<#
    }
#>
<#
    if (inherits != null)
    {
#>
			: base(
				<#= camelCasedModelName #><#= (ancestorsHasClient ? "," : ")") #>
<#
	if (ancestorsHasClient)
	{
#>
				client)
<#
	}
#>
<#
    }
#>
		{
			Contract.Requires<ArgumentNullException>(<#= camelCasedModelName #> != null);
<#
    if (hasClient || ancestorsHasClient)
    {
#>

			Contract.Requires<ArgumentNullException>(client != null);
<#
    }
#>

			this._<#= camelCasedModelName #> = <#= camelCasedModelName #>;
<#
    if (hasClient)
    {
#>

			this._client = client;
<#
    }
#>
		}
<#
	foreach (var member in members)
	{
#>

		/// <summary>Map to "<#= member.Json #>"</summary>
		public <#= member.Type #> <#= member.Name #>
		{
			get
			{
				return this._<#= camelCasedModelName #>.<#= member.Name #>;
			}
		}
<#
	}
#>
<#
    if (hasClient)
    {
#>
		public IGitHubClient Client
		{
			get
			{
				Contract.Ensures(Contract.Result<IGitHubClient>() != null);

				return this._client;
			}
		}

<#
    }
#>

		/// <summary>Specifies invariant contracts of object.</summary>
        [Conditional("CONTRACTS_FULL")]
        [EditorBrowsable(EditorBrowsableState.Never)]
        [ContractInvariantMethod]
        private void ObjectInvariant()
        {
            Contract.Invariant(this._<#= camelCasedModelName #> != null);
<#
    if (hasClient)
    {
#>

			Contract.Invariant(this._client != null);
<#
    }
#>
        }
	}
}
